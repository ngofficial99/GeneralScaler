apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: generalscalers.autoscaling.generalscaler.io
spec:
  group: autoscaling.generalscaler.io
  names:
    kind: GeneralScaler
    listKind: GeneralScalerList
    plural: generalscalers
    singular: generalscaler
    shortNames:
      - gs
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - targetRef
                - minReplicas
                - maxReplicas
                - metric
              properties:
                # Target deployment to scale
                targetRef:
                  type: object
                  required:
                    - apiVersion
                    - kind
                    - name
                  properties:
                    apiVersion:
                      type: string
                      default: "apps/v1"
                    kind:
                      type: string
                      default: "Deployment"
                    name:
                      type: string

                # Replica constraints
                minReplicas:
                  type: integer
                  minimum: 1
                  default: 1

                maxReplicas:
                  type: integer
                  minimum: 1

                # Metric configuration
                metric:
                  type: object
                  required:
                    - type
                  properties:
                    type:
                      type: string
                      enum:
                        - prometheus
                        - redis
                        - pubsub
                        - custom

                    # Target value for the metric
                    targetValue:
                      type: number
                      default: 100

                    # Prometheus-specific config
                    prometheus:
                      type: object
                      properties:
                        serverUrl:
                          type: string
                        query:
                          type: string
                        headers:
                          type: object
                          additionalProperties:
                            type: string

                    # Redis-specific config
                    redis:
                      type: object
                      properties:
                        host:
                          type: string
                        port:
                          type: integer
                          default: 6379
                        password:
                          type: string
                        db:
                          type: integer
                          default: 0
                        queueName:
                          type: string
                        # Secret reference for password
                        passwordSecret:
                          type: object
                          properties:
                            name:
                              type: string
                            key:
                              type: string

                    # Pub/Sub-specific config
                    pubsub:
                      type: object
                      properties:
                        projectId:
                          type: string
                        subscriptionId:
                          type: string
                        credentialsSecret:
                          type: object
                          properties:
                            name:
                              type: string
                            key:
                              type: string

                    # Custom metric endpoint
                    custom:
                      type: object
                      properties:
                        url:
                          type: string
                        method:
                          type: string
                          default: "GET"
                        headers:
                          type: object
                          additionalProperties:
                            type: string
                        jsonPath:
                          type: string
                          description: "JSONPath expression to extract metric value"

                # Policy configuration
                policy:
                  type: object
                  properties:
                    type:
                      type: string
                      enum:
                        - simple
                        - slo
                        - costAware
                      default: "simple"

                    # SLO-based policy
                    slo:
                      type: object
                      properties:
                        targetLatencyMs:
                          type: number
                          description: "Target latency in milliseconds"
                        targetErrorRate:
                          type: number
                          description: "Target error rate (0.0-1.0)"
                          minimum: 0
                          maximum: 1

                    # Cost-aware policy
                    costAware:
                      type: object
                      properties:
                        maxMonthlyCost:
                          type: number
                          description: "Maximum monthly cost in USD"
                        costPerPodPerHour:
                          type: number
                          description: "Cost per pod per hour in USD"
                        preferredScaleDirection:
                          type: string
                          enum:
                            - up
                            - down
                            - balanced
                          default: "balanced"

                # Scaling behavior configuration
                behavior:
                  type: object
                  properties:
                    scaleUp:
                      type: object
                      properties:
                        # Maximum replicas to add at once
                        maxIncrement:
                          type: integer
                          minimum: 1
                          default: 5
                        # Cooldown period in seconds
                        cooldownSeconds:
                          type: integer
                          minimum: 0
                          default: 60

                    scaleDown:
                      type: object
                      properties:
                        # Maximum replicas to remove at once
                        maxDecrement:
                          type: integer
                          minimum: 1
                          default: 2
                        # Cooldown period in seconds
                        cooldownSeconds:
                          type: integer
                          minimum: 0
                          default: 300

                # Sync interval
                syncIntervalSeconds:
                  type: integer
                  minimum: 10
                  default: 30
                  description: "How often to check metrics and scale"

            status:
              type: object
              properties:
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string

                currentReplicas:
                  type: integer

                desiredReplicas:
                  type: integer

                currentMetricValue:
                  type: number

                lastScaleTime:
                  type: string
                  format: date-time

                lastMetricCheckTime:
                  type: string
                  format: date-time

      # Additional printer columns for kubectl get
      additionalPrinterColumns:
        - name: Target
          type: string
          jsonPath: .spec.targetRef.name
        - name: Min
          type: integer
          jsonPath: .spec.minReplicas
        - name: Max
          type: integer
          jsonPath: .spec.maxReplicas
        - name: Current
          type: integer
          jsonPath: .status.currentReplicas
        - name: Desired
          type: integer
          jsonPath: .status.desiredReplicas
        - name: Metric
          type: string
          jsonPath: .spec.metric.type
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp

      subresources:
        status: {}
