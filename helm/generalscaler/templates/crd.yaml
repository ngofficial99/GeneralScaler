{{- if .Values.rbac.create -}}
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: generalscalers.autoscaling.generalscaler.io
  labels:
    {{- include "generalscaler.labels" . | nindent 4 }}
spec:
  group: autoscaling.generalscaler.io
  names:
    kind: GeneralScaler
    listKind: GeneralScalerList
    plural: generalscalers
    singular: generalscaler
    shortNames:
      - gs
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - targetRef
                - minReplicas
                - maxReplicas
                - metric
              properties:
                targetRef:
                  type: object
                  required:
                    - apiVersion
                    - kind
                    - name
                  properties:
                    apiVersion:
                      type: string
                      default: "apps/v1"
                    kind:
                      type: string
                      default: "Deployment"
                    name:
                      type: string
                minReplicas:
                  type: integer
                  minimum: 1
                  default: 1
                maxReplicas:
                  type: integer
                  minimum: 1
                metric:
                  type: object
                  required:
                    - type
                  properties:
                    type:
                      type: string
                      enum:
                        - prometheus
                        - redis
                        - pubsub
                        - custom
                    targetValue:
                      type: number
                      default: 100
                    prometheus:
                      type: object
                      properties:
                        serverUrl:
                          type: string
                        query:
                          type: string
                        headers:
                          type: object
                          additionalProperties:
                            type: string
                    redis:
                      type: object
                      properties:
                        host:
                          type: string
                        port:
                          type: integer
                          default: 6379
                        password:
                          type: string
                        db:
                          type: integer
                          default: 0
                        queueName:
                          type: string
                        passwordSecret:
                          type: object
                          properties:
                            name:
                              type: string
                            key:
                              type: string
                    pubsub:
                      type: object
                      properties:
                        projectId:
                          type: string
                        subscriptionId:
                          type: string
                        credentialsSecret:
                          type: object
                          properties:
                            name:
                              type: string
                            key:
                              type: string
                    custom:
                      type: object
                      properties:
                        url:
                          type: string
                        method:
                          type: string
                          default: "GET"
                        headers:
                          type: object
                          additionalProperties:
                            type: string
                        jsonPath:
                          type: string
                policy:
                  type: object
                  properties:
                    type:
                      type: string
                      enum:
                        - simple
                        - slo
                        - costAware
                      default: "simple"
                    slo:
                      type: object
                      properties:
                        targetLatencyMs:
                          type: number
                        targetErrorRate:
                          type: number
                          minimum: 0
                          maximum: 1
                    costAware:
                      type: object
                      properties:
                        maxMonthlyCost:
                          type: number
                        costPerPodPerHour:
                          type: number
                        preferredScaleDirection:
                          type: string
                          enum:
                            - up
                            - down
                            - balanced
                          default: "balanced"
                behavior:
                  type: object
                  properties:
                    scaleUp:
                      type: object
                      properties:
                        maxIncrement:
                          type: integer
                          minimum: 1
                          default: 5
                        cooldownSeconds:
                          type: integer
                          minimum: 0
                          default: 60
                    scaleDown:
                      type: object
                      properties:
                        maxDecrement:
                          type: integer
                          minimum: 1
                          default: 2
                        cooldownSeconds:
                          type: integer
                          minimum: 0
                          default: 300
                syncIntervalSeconds:
                  type: integer
                  minimum: 10
                  default: 30
            status:
              type: object
              properties:
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
                currentReplicas:
                  type: integer
                desiredReplicas:
                  type: integer
                currentMetricValue:
                  type: number
                lastScaleTime:
                  type: string
                  format: date-time
                lastMetricCheckTime:
                  type: string
                  format: date-time
      additionalPrinterColumns:
        - name: Target
          type: string
          jsonPath: .spec.targetRef.name
        - name: Min
          type: integer
          jsonPath: .spec.minReplicas
        - name: Max
          type: integer
          jsonPath: .spec.maxReplicas
        - name: Current
          type: integer
          jsonPath: .status.currentReplicas
        - name: Desired
          type: integer
          jsonPath: .status.desiredReplicas
        - name: Metric
          type: string
          jsonPath: .spec.metric.type
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      subresources:
        status: {}
{{- end }}
